{% extends "base.html" %}
{% block content %}
{% include 'navbar.html' %}

<main>
  <div class="col-sm-12 col-md-10 col-lg-7 mx-auto">
    <div class="circle-rectangle">
      <div class="article">
        <div>
          <div class="row">
            <div class="col">
              <img src="../static/img/profile.png" class="bigCircle" alt="user profile" id="profilePic" title="Click to resolve this item- it will be removed for you and all other users" />
            </div>
          </div>

          <div class="your_items_container user_subtitle row">
            <div class="col">YOUR ITEMS</div>
            {% for item in items %}
            <div class="row {% if item.type == 'Request' %} userRequest {% else %} userOffer {% endif %}" data-id="{{ item.id }}">
              <div class="col">{{ item.description }}</div>
              <div class="col-sm-5 userbuttons">
                {% if item.acceptor_id %}
                <a href="mailto:{{ item.acceptor_email }}" class="contact-button">Contact &nbsp;<span>{{ item.acceptor_name }}</span></a>
                {% endif %}
                <img src="../static/img/tick.png" class="circlesmall complete-activity" alt="tick" id="checkmark" title="Click to resolve this item- it will be removed for you and all other users" />
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="row">
            <div class="col" style="text-align: center">
              <a href="{{ url_for('form') }}">
                <img src="../static/img/plus.jpg" class="circle" alt="plus symbol" id="plusSign" title="Click the plus button to create a new Offer or Request!" />
              </a>
            </div>
          </div>

          <div class="your_items_container user_subtitle row">
            <div class="col">YOUR ACCEPTS</div>
            {% for accept in accepts %}
            <div class="row {% if accept.type == 'Request' %} userRequest {% else %} userOffer {% endif %}">
                <div class="col">{{ accept.description }}</div>
                <div class="col-sm-5 userbuttons">
                    {% if accept.author_id %}
                    <a href="mailto:{{ accept.author_email }}" class="contact-button">Contact &nbsp;<span>{{ accept.author_name }}</span></a>
                    {% endif %}
                    <img src="../static/img/tick.png" class="circlesmall" alt="tick" id="checkmark" title="Click to resolve this item- it will be removed for you and all other users" />
                </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="row">
          <div></div>
        </div>
      </div>
    </div>
  </div>
</main>
{% if session.get('show_welcome', False) %}
<script>
    var showWelcomeModal = {{ session.get('show_welcome', False) | tojson }};
</script>
<script src="../static/welcomeModal.js"></script>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token() }}';
    document.querySelectorAll('.complete-activity').forEach(function(element) {
      element.addEventListener('click', function() {
        const activityRow = this.closest('.row');
        const activityId = activityRow.getAttribute('data-id');
        console.log(`Attempting to complete activity with id: ${activityId}`);

        fetch(`/complete_activity/${activityId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken // Pass CSRF token in the headers
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(`Activity with id: ${activityId} completed successfully.`);
            activityRow.remove();
          } else {
            console.error(data.error || 'An error occurred while completing the activity.');
          }
        })
        .catch(error => console.error('Error:', error));
      });
    });
  });
</script>

{% endblock %}
